generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model User {
  id                    String             @id
  email                 String?            @unique @db.Citext
  name                  String?
  locale                String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  profileStatus         ProfileStatus      @default(INCOMPLETE)
  collectionMemberships CollectionMember[]
  collections           Collection[]
  samples               Sample[]
  sentInvites           Invite[]           @relation("invite_inviter")
  receivedInvites       Invite[]           @relation("invite_invitee")
  auditLogs             AuditLog[]         @relation("audit_actor")
  auditLogTargets       AuditLog[]         @relation("audit_target_user")
  sellerProfile         SellerProfile?
  reviewedSellerProfiles SellerProfile[]   @relation("seller_profiles_reviewers")

  @@map("users")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model Collection {
  id        String             @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  deletedAt DateTime?
  isDeleted Boolean            @default(false)
  members   CollectionMember[]
  samples   CollectionSample[]
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  invites   Invite[]
  auditLogs AuditLog[]

  @@unique([userId, name])
  @@index([userId, updatedAt])
  @@map("collections")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model Sample {
  id              String             @id @default(cuid())
  userId          String
  title           String
  materialType    String
  applicationArea String?
  surface         String?
  colorHex        String?            @db.Char(7)
  colorName       String?
  companyName     String?
  priceMinor      Int?
  priceCurrency   String?            @db.Char(3)
  quantityValue   Decimal?           @db.Decimal(10, 2)
  quantityUnit    String?
  sizeText        String?
  locationLat     Decimal?           @db.Decimal(9, 6)
  locationLng     Decimal?           @db.Decimal(9, 6)
  notes           String?
  isDeleted       Boolean            @default(false)
  isPublic        Boolean            @default(false)
  publishedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?
  collections     CollectionSample[]
  image           SampleImage?
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, updatedAt])
  @@index([isDeleted])
  @@index([isPublic, isDeleted])
  @@map("samples")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model SampleImage {
  id              String    @id @default(cuid())
  sampleId        String    @unique
  storageProvider String
  objectKey       String
  url             String
  width           Int?
  height          Int?
  blurhash        String?
  exif            Json?
  createdAt       DateTime  @default(now())
  deletedAt       DateTime?
  sample          Sample    @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  @@map("sample_images")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model CollectionSample {
  collectionId String
  sampleId     String
  position     Int
  addedAt      DateTime   @default(now())
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  sample       Sample     @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  @@id([collectionId, sampleId])
  @@index([collectionId, position])
  @@map("collection_samples")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model CollectionMember {
  id           String         @id @default(cuid())
  collectionId String
  userId       String
  role         CollectionRole
  createdAt    DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @updatedAt @db.Timestamptz(6)
  collection   Collection     @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId], map: "collection_members_collection_id_user_id_key")
  @@index([collectionId, role], map: "collection_members_collection_id_role_idx")
  @@index([userId], map: "collection_members_user_id_idx")
  @@map("collection_members")
}

/// ///////////////////////////////////////////////////////
/// ///////////////////////////////////////////////////////
model CleanupTask {
  id          String        @id @default(cuid())
  entityType  CleanupEntity
  entityId    String
  payload     Json?
  status      CleanupStatus @default(PENDING)
  attempts    Int           @default(0)
  scheduledAt DateTime      @default(now())
  lastError   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status, scheduledAt])
  @@map("cleanup_tasks")
}

enum ProfileStatus {
  INCOMPLETE
  COMPLETE
}

enum CollectionRole {
  OWNER
  EDITOR
  VIEW_ONLY
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum CleanupEntity {
  SAMPLE
  USER
}

enum CleanupStatus {
  PENDING
  RUNNING
  FAILED
  COMPLETED
}

model SellerProfile {
  id                 String                @id @default(cuid())
  userId             String
  companyName        String
  brandName          String
  productCategories  String[]              @db.Text
  countryCode        String                @db.VarChar(2)
  contactName        String
  contactPhone       String
  contactEmail       String                @db.Citext
  taxId              String
  status             SellerProfileStatus   @default(PENDING)
  reviewedById       String?
  reviewedAt         DateTime?
  rejectionReason    String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy         User?                 @relation("seller_profiles_reviewers", fields: [reviewedById], references: [id])

  @@unique([userId])
  @@index([status])
  @@map("seller_profiles")
}

enum SellerProfileStatus {
  PENDING
  APPROVED
  REJECTED
}

model Invite {
  id              String         @id @default(cuid())
  collectionId    String         @map("collection_id")
  inviterId       String         @map("inviter_id")
  inviteeUserId   String?        @map("invitee_user_id")
  inviteeUsername String?        @map("invitee_username")
  inviteeEmail    String?        @db.Citext @map("invitee_email")
  role            CollectionRole
  token           String         @unique
  status          InviteStatus   @default(PENDING)
  expiresAt       DateTime       @map("expires_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  inviter    User       @relation("invite_inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee    User?      @relation("invite_invitee", fields: [inviteeUserId], references: [id])
  auditLogs  AuditLog[]

  @@index([collectionId, status])
  @@map("invites")
}

model AuditLog {
  id           String    @id @default(cuid())
  actorId      String    @map("actor_id")
  action       String
  collectionId String?   @map("collection_id")
  targetUserId String?   @map("target_user_id")
  inviteId     String?   @map("invite_id")
  metadata     Json?     @map("metadata")
  createdAt    DateTime  @default(now()) @map("created_at")

  actor        User        @relation("audit_actor", fields: [actorId], references: [id], onDelete: Cascade)
  targetUser   User?       @relation("audit_target_user", fields: [targetUserId], references: [id])
  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  invite       Invite?     @relation(fields: [inviteId], references: [id])

  @@map("audit_logs")
}
